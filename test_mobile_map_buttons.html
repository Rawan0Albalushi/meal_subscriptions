<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار أزرار الخريطة على الهاتف</title>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #faeeee 0%, #eefafa 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .map-container {
            position: relative;
            margin: 20px 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        #map {
            width: 100%;
            height: 400px;
            position: relative;
            z-index: 1;
        }
        
        .test-info {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* تحسينات للهاتف المحمول */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            #map {
                height: 300px;
            }
            
            .test-info {
                padding: 15px;
            }
        }
        
        /* تحسينات Leaflet للهاتف */
        .leaflet-control-container {
            z-index: 1000 !important;
        }
        .leaflet-control {
            z-index: 1000 !important;
        }
        .leaflet-control-layers {
            z-index: 1000 !important;
        }
        .leaflet-control-layers-toggle {
            z-index: 1000 !important;
        }
        
        @media (max-width: 768px) {
            .leaflet-control {
                font-size: 14px !important;
            }
            .leaflet-control-layers {
                font-size: 14px !important;
                min-width: 120px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #2f6e73; margin-bottom: 30px;">
            🗺️ اختبار أزرار الخريطة على الهاتف المحمول
        </h1>
        
        <div class="test-info">
            <h3>📱 معلومات الاختبار:</h3>
            <div id="device-info" class="info">
                <p><strong>نوع الجهاز:</strong> <span id="device-type">جاري التحديد...</span></p>
                <p><strong>عرض الشاشة:</strong> <span id="screen-width">جاري التحديد...</span></p>
                <p><strong>ارتفاع الشاشة:</strong> <span id="screen-height">جاري التحديد...</span></p>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
        
        <div class="test-info">
            <h3>🔍 نتائج الاختبار:</h3>
            <div id="test-results">
                <div class="info">جاري فحص الأزرار...</div>
            </div>
        </div>
        
        <div class="test-info">
            <h3>📋 تعليمات الاختبار:</h3>
            <ol>
                <li>تأكد من أن زر تحديد الموقع (📍) يظهر في الزاوية اليمنى العلوية</li>
                <li>تأكد من أن زر تبديل الطبقات يظهر في الزاوية اليمنى السفلى</li>
                <li>جرب النقر على الأزرار للتأكد من عملها</li>
                <li>جرب تغيير حجم النافذة لاختبار الاستجابة</li>
            </ol>
        </div>
    </div>

    <script>
        // تحديد معلومات الجهاز
        function updateDeviceInfo() {
            const deviceType = window.innerWidth <= 768 ? 'هاتف محمول' : 'سطح المكتب';
            document.getElementById('device-type').textContent = deviceType;
            document.getElementById('screen-width').textContent = window.innerWidth + 'px';
            document.getElementById('screen-height').textContent = window.innerHeight + 'px';
        }
        
        // تحديث معلومات الجهاز عند تغيير حجم النافذة
        window.addEventListener('resize', updateDeviceInfo);
        updateDeviceInfo();
        
        // إصلاح مشكلة أيقونات Leaflet
        delete L.Icon.Default.prototype._getIconUrl;
        L.Icon.Default.mergeOptions({
            iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        });
        
        // إنشاء الخريطة
        const map = L.map('map').setView([23.5880, 58.3829], 13);
        
        // إضافة طبقة الخريطة الأساسية
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19,
        }).addTo(map);
        
        // إضافة طبقة خريطة الأقمار الصناعية
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri',
            maxZoom: 19,
        });
        
        // إنشاء مجموعة الطبقات
        const baseMaps = {
            "الخريطة الأساسية": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19,
            }),
            "الأقمار الصناعية": satelliteLayer
        };
        
        // إضافة التحكم في الطبقات
        const layerControl = L.control.layers(baseMaps).addTo(map);
        
        // تحسين التحكم في الطبقات للهاتف
        setTimeout(() => {
            const layerControlContainer = layerControl.getContainer();
            if (layerControlContainer) {
                layerControlContainer.style.zIndex = '1000';
                layerControlContainer.style.position = 'relative';
                
                if (window.innerWidth <= 768) {
                    layerControlContainer.style.fontSize = '14px';
                    layerControlContainer.style.padding = '8px';
                    layerControlContainer.style.borderRadius = '8px';
                    layerControlContainer.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    layerControlContainer.style.minWidth = '120px';
                }
            }
        }, 100);
        
        // إضافة زر تحديد الموقع الحالي
        const locationButton = L.control({ position: 'topright' });
        locationButton.onAdd = function () {
            const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            div.innerHTML = `
                <button 
                    title="تحديد موقعي الحالي"
                    style="
                        width: 44px; 
                        height: 44px; 
                        background-color: white; 
                        color: #374151; 
                        font-weight: bold; 
                        border: 2px solid #d1d5db; 
                        border-radius: 8px; 
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-size: 18px; 
                        cursor: pointer;
                        transition: all 0.2s ease;
                        z-index: 1000;
                    "
                    onmouseover="this.style.backgroundColor='#f3f4f6'; this.style.transform='scale(1.05)'"
                    onmouseout="this.style.backgroundColor='white'; this.style.transform='scale(1)'"
                >
                    📍
                </button>
            `;
            
            div.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                getCurrentLocation();
            };
            return div;
        };
        locationButton.addTo(map);
        
        // تحسين الزر للهاتف
        setTimeout(() => {
            const buttonElement = locationButton.getContainer()?.querySelector('button');
            if (buttonElement) {
                // إضافة touch events للهاتف
                buttonElement.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    buttonElement.style.backgroundColor = '#f3f4f6';
                    buttonElement.style.transform = 'scale(1.05)';
                });
                
                buttonElement.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    buttonElement.style.backgroundColor = 'white';
                    buttonElement.style.transform = 'scale(1)';
                });
                
                // تحسين الحجم والموضع للهاتف
                if (window.innerWidth <= 768) {
                    buttonElement.style.width = '48px';
                    buttonElement.style.height = '48px';
                    buttonElement.style.fontSize = '20px';
                    buttonElement.style.borderRadius = '10px';
                    buttonElement.style.zIndex = '1000';
                    buttonElement.style.position = 'relative';
                }
                
                // تحسين z-index للعنصر الأب
                const container = locationButton.getContainer();
                if (container) {
                    container.style.zIndex = '1000';
                    container.style.position = 'relative';
                }
            }
        }, 100);
        
        // دالة تحديد الموقع الحالي
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        map.setView([latitude, longitude], 16);
                        
                        // إضافة مؤشر موقع المستخدم
                        const userMarker = L.marker([latitude, longitude], {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: '<div style="background-color: #4a8a8f; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                                iconSize: [16, 16],
                                iconAnchor: [8, 8]
                            })
                        }).addTo(map).bindPopup('موقعك الحالي', {
                            closeButton: false,
                            closeOnClick: false
                        });
                        
                        updateTestResults('success', 'تم تحديد الموقع بنجاح!');
                    },
                    (error) => {
                        console.error('خطأ في تحديد الموقع:', error);
                        updateTestResults('error', 'تعذر تحديد الموقع. تأكد من السماح بالوصول للموقع.');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            } else {
                updateTestResults('error', 'متصفحك لا يدعم تحديد الموقع الجغرافي.');
            }
        }
        
        // تحديث نتائج الاختبار
        function updateTestResults(type, message) {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }
        
        // فحص الأزرار بعد تحميل الخريطة
        setTimeout(() => {
            const locationButtonContainer = locationButton.getContainer();
            const layerControlContainer = layerControl.getContainer();
            
            let results = [];
            
            if (locationButtonContainer && locationButtonContainer.querySelector('button')) {
                results.push('<div class="success">✅ زر تحديد الموقع يظهر بشكل صحيح</div>');
            } else {
                results.push('<div class="error">❌ زر تحديد الموقع لا يظهر</div>');
            }
            
            if (layerControlContainer) {
                results.push('<div class="success">✅ زر تبديل الطبقات يظهر بشكل صحيح</div>');
            } else {
                results.push('<div class="error">❌ زر تبديل الطبقات لا يظهر</div>');
            }
            
            if (window.innerWidth <= 768) {
                results.push('<div class="info">📱 تم تطبيق تحسينات الهاتف المحمول</div>');
            } else {
                results.push('<div class="info">💻 وضع سطح المكتب</div>');
            }
            
            document.getElementById('test-results').innerHTML = results.join('');
        }, 1000);
        
        // إضافة مؤشر قابل للسحب
        const marker = L.marker([23.5880, 58.3829], {
            draggable: true,
            icon: L.divIcon({
                className: 'custom-marker',
                html: '<div style="background-color: #b65449; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            })
        }).addTo(map);
        
        marker.bindPopup(`
            <div style="text-align: center; font-family: Calibri, Arial, sans-serif;">
                <div style="font-weight: bold; margin-bottom: 5px;">اسحب المؤشر لتحديد موقعك</div>
                <div style="font-size: 12px; color: #666;">
                    ${23.5880.toFixed(6)}, ${58.3829.toFixed(6)}
                </div>
            </div>
        `, {
            closeButton: false,
            closeOnClick: false
        });
        
        marker.on('dragend', (e) => {
            const { lat, lng } = e.target.getLatLng();
            marker.setPopupContent(`
                <div style="text-align: center; font-family: Calibri, Arial, sans-serif;">
                    <div style="font-weight: bold; margin-bottom: 5px;">الموقع المحدد</div>
                    <div style="font-size: 12px; color: #666;">
                        ${lat.toFixed(6)}, ${lng.toFixed(6)}
                    </div>
                </div>
            `);
        });
    </script>
</body>
</html>

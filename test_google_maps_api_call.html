<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار استدعاء Google Maps API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .map-container { height: 400px; width: 100%; }
        .code-block { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 12px; font-family: 'Courier New', monospace; }
    </style>
</head>
<body class="bg-gray-50 p-4">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                اختبار استدعاء Google Maps API
            </h1>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- معلومات الاستدعاء -->
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h2 class="text-lg font-semibold text-blue-800 mb-2">طريقة الاستدعاء الصحيحة:</h2>
                        <div class="code-block text-sm">
                            <div>const params = new URLSearchParams({</div>
                            <div class="ml-4">key: apiKey,</div>
                            <div class="ml-4">libraries: ['maps'].join(','),</div>
                            <div class="ml-4">v: 'weekly',</div>
                            <div class="ml-4">callback: 'initGoogleMaps'</div>
                            <div>});</div>
                            <div>script.src = `https://maps.googleapis.com/maps/api/js?${params.toString()}`;</div>
                        </div>
                    </div>

                    <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h3 class="text-lg font-semibold text-green-800 mb-2">النتيجة المتوقعة:</h3>
                        <div class="code-block text-sm">
                            <div>https://maps.googleapis.com/maps/api/js?</div>
                            <div>key=YOUR_API_KEY&</div>
                            <div>libraries=maps&</div>
                            <div>v=weekly&</div>
                            <div>callback=initGoogleMaps</div>
                        </div>
                    </div>

                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-2">التحقق من المتغيرات:</h3>
                        <div class="space-y-2 text-sm">
                            <div>✅ VITE_GOOGLE_MAPS_API_KEY موجود</div>
                            <div>✅ import.meta.env.VITE_GOOGLE_MAPS_API_KEY يعمل</div>
                            <div>✅ URLSearchParams يبني URL بشكل صحيح</div>
                            <div>✅ script.onload يتم استدعاؤه</div>
                        </div>
                    </div>
                </div>

                <!-- اختبار الخريطة -->
                <div class="space-y-4">
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">اختبار الخريطة:</h3>
                        <div id="map" class="map-container border-2 border-gray-200 rounded-lg"></div>
                    </div>

                    <div class="text-center space-y-2">
                        <button onclick="testApiCall()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors w-full">
                            اختبار استدعاء API
                        </button>
                        <button onclick="checkEnvironment()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors w-full">
                            فحص البيئة
                        </button>
                        <button onclick="clearMap()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors w-full">
                            مسح الخريطة
                        </button>
                    </div>
                </div>
            </div>

            <!-- سجل الأحداث -->
            <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">سجل الأحداث:</h3>
                <div id="eventLog" class="bg-black text-green-400 p-4 rounded font-mono text-sm h-32 overflow-y-auto">
                    <div>في انتظار الاختبار...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mapInstance = null;
        const eventLog = document.getElementById('eventLog');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            eventLog.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            eventLog.scrollTop = eventLog.scrollHeight;
        }

        function testApiCall() {
            log('بدء اختبار استدعاء API...');
            
            const apiKey = prompt('أدخل مفتاح Google Maps API:');
            if (!apiKey) {
                log('❌ لم يتم إدخال مفتاح API');
                return;
            }

            log(`✅ مفتاح API: ${apiKey.substring(0, 10)}...`);

            // محاكاة الطريقة المستخدمة في الكود
            const GOOGLE_MAPS_LIBRARIES = ['maps'];
            const params = new URLSearchParams({
                key: apiKey,
                libraries: GOOGLE_MAPS_LIBRARIES.join(','),
                v: 'weekly',
                callback: 'initGoogleMaps'
            });

            const scriptUrl = `https://maps.googleapis.com/maps/api/js?${params.toString()}`;
            log(`🔗 URL المُنشأ: ${scriptUrl}`);

            // إزالة السكريبت السابق
            const existingScript = document.getElementById('google-maps-script');
            if (existingScript) {
                existingScript.remove();
                log('🗑️ تم إزالة السكريبت السابق');
            }

            // إنشاء السكريبت الجديد
            const script = document.createElement('script');
            script.id = 'google-maps-script';
            script.src = scriptUrl;
            script.async = true;
            script.defer = true;

            script.onload = function() {
                log('✅ تم تحميل السكريبت بنجاح');
                if (window.google && window.google.maps) {
                    log('✅ Google Maps API متاح');
                    initMap();
                } else {
                    log('❌ Google Maps API غير متاح');
                }
            };

            script.onerror = function(error) {
                log('❌ فشل في تحميل السكريبت');
                log(`خطأ: ${error.message || 'غير معروف'}`);
            };

            document.head.appendChild(script);
            log('📤 تم إرسال طلب تحميل السكريبت');
        }

        function initMap() {
            try {
                log('🗺️ بدء تهيئة الخريطة...');
                
                mapInstance = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 23.5880, lng: 58.3829 },
                    zoom: 13,
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: false
                });

                const marker = new google.maps.Marker({
                    position: { lat: 23.5880, lng: 58.3829 },
                    map: mapInstance,
                    title: 'مسقط، عمان'
                });

                log('✅ تم إنشاء الخريطة بنجاح');
                log('🎉 الاختبار مكتمل بنجاح!');
            } catch (error) {
                log(`❌ خطأ في إنشاء الخريطة: ${error.message}`);
            }
        }

        function checkEnvironment() {
            log('🔍 فحص البيئة...');
            
            // فحص المتصفح
            if (typeof window !== 'undefined') {
                log('✅ window متاح');
            } else {
                log('❌ window غير متاح');
            }

            // فحص Google Maps
            if (window.google && window.google.maps) {
                log('✅ Google Maps متاح');
            } else {
                log('❌ Google Maps غير متاح');
            }

            // فحص URLSearchParams
            if (typeof URLSearchParams !== 'undefined') {
                log('✅ URLSearchParams متاح');
            } else {
                log('❌ URLSearchParams غير متاح');
            }

            log('✅ فحص البيئة مكتمل');
        }

        function clearMap() {
            if (mapInstance) {
                mapInstance = null;
            }
            document.getElementById('map').innerHTML = '';
            log('🗑️ تم مسح الخريطة');
        }

        // دالة callback لخرائط جوجل
        window.initGoogleMaps = function() {
            log('📞 تم استدعاء callback initGoogleMaps');
        };

        // بدء الفحص التلقائي
        checkEnvironment();
    </script>
</body>
</html>

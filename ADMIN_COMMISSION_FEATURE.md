# ميزة نسبة مكسب الإدارة - Admin Commission Feature

## 📋 نظرة عامة
تم إضافة ميزة جديدة تسمح للإدارة بتحديد نسبة مكسب من كل نوع اشتراك. هذه النسبة اختيارية ويمكن استخدامها لحساب مستحقات التاجر ومكسب الإدارة في التقارير.

## 🆕 الميزات الجديدة

### 1. حقل Admin Commission في أنواع الاشتراك
- **حقل جديد**: `admin_commission` في جدول `subscription_types`
- **النوع**: `decimal(5,2)` - يدعم النسب المئوية حتى 100.00%
- **اختياري**: يمكن تركه فارغ (null)
- **التحقق**: يجب أن تكون القيمة بين 0 و 100

### 2. تحديث واجهة الإدارة
- **نموذج إضافة نوع اشتراك**: يتضمن حقل نسبة مكسب الإدارة
- **نموذج تعديل نوع اشتراك**: يمكن تعديل النسبة المحددة مسبقاً
- **التصميم**: حقل واضح مع شرح وملاحظات للمستخدم

### 3. تحسين التقارير
التقارير الآن تعرض تفاصيل الأسعار التالية:
- **سعر الاشتراك**: السعر الأساسي لنوع الاشتراك
- **سعر التوصيل**: تكلفة التوصيل
- **سعر الاشتراك ناقص التوصيل**: السعر الأساسي بدون التوصيل
- **نسبة مكسب الإدارة**: النسبة المحددة (مثال: 10%)
- **مبلغ مكسب الإدارة**: المبلغ المحسوب من النسبة
- **مستحقات التاجر**: السعر الأساسي ناقص مكسب الإدارة

## 🔧 التغييرات التقنية

### 1. قاعدة البيانات
```sql
-- Migration: add_admin_commission_to_subscription_types_table
ALTER TABLE subscription_types 
ADD COLUMN admin_commission DECIMAL(5,2) NULL 
AFTER delivery_price 
COMMENT 'Admin commission percentage (0-100)';
```

### 2. النموذج (Model)
```php
// SubscriptionType Model
protected $fillable = [
    // ... existing fields
    'admin_commission',
];

protected $casts = [
    // ... existing casts
    'admin_commission' => 'decimal:2',
];

// Accessor methods
public function getCommissionAmountAttribute()
{
    if (!$this->admin_commission) {
        return 0;
    }
    // النسبة تحسب من سعر الاشتراك بدون التوصيل
    $subscriptionPriceWithoutDelivery = $this->price - $this->delivery_price;
    return ($subscriptionPriceWithoutDelivery * $this->admin_commission) / 100;
}

public function getMerchantAmountAttribute()
{
    $subscriptionPriceWithoutDelivery = $this->price - $this->delivery_price;
    return $subscriptionPriceWithoutDelivery - $this->commission_amount;
}
```

### 3. API Controllers
- **SubscriptionTypeController**: دعم حقل `admin_commission` في إنشاء وتحديث أنواع الاشتراك
- **ReportsController**: حساب وعرض تفاصيل الأسعار الجديدة في التقارير

### 4. Frontend
- **Admin SubscriptionTypes**: نموذج محدث مع حقل Admin Commission
- **Admin Reports**: جدول تقارير محدث مع أعمدة الأسعار الجديدة
- **Export Excel**: ملف Excel محدث مع التفاصيل الجديدة

## 📊 مثال على الحسابات

لنفترض أن لدينا نوع اشتراك:
- **سعر الاشتراك**: 25.00 ريال
- **سعر التوصيل**: 2.00 ريال  
- **نسبة مكسب الإدارة**: 10%

### النتائج:
- **سعر الاشتراك ناقص التوصيل**: 23.00 ريال (25 - 2)
- **مبلغ مكسب الإدارة**: 2.30 ريال (23 × 10%) - **يحسب من السعر بدون التوصيل**
- **مستحقات التاجر**: 20.70 ريال (23 - 2.30)

## 🧪 الاختبار

تم إنشاء ملف اختبار شامل: `test_admin_commission_feature.html`

### وظائف الاختبار:
1. **اختبار إنشاء نوع اشتراك** مع نسبة مكسب الإدارة
2. **اختبار API التقارير** مع البيانات الجديدة
3. **التحقق من هيكل قاعدة البيانات**
4. **عرض الحسابات** بشكل تفاعلي
5. **التحقق من حالة Migration**

## 🚀 كيفية الاستخدام

### 1. إضافة نوع اشتراك جديد
1. انتقل إلى لوحة الإدارة > أنواع الاشتراك
2. اضغط على "إضافة نوع اشتراك جديد"
3. املأ البيانات المطلوبة
4. في حقل "نسبة مكسب الإدارة" أدخل النسبة (مثال: 10)
5. احفظ النوع

### 2. عرض التقارير
1. انتقل إلى التقارير
2. ستجد الجدول محدث بعمودين جديدين:
   - "نسبة مكسب الإدارة"
   - "مبلغ مكسب الإدارة"  
   - "مستحقات التاجر"
3. يمكن تصدير البيانات إلى Excel مع التفاصيل الجديدة

### 3. تصدير التقارير
التقارير المصدرة تتضمن الآن:
- سعر الاشتراك (بالريال)
- سعر التوصيل (بالريال)
- سعر الاشتراك ناقص التوصيل (بالريال)
- نسبة مكسب الإدارة (%)
- مبلغ مكسب الإدارة (بالريال)
- مستحقات التاجر (بالريال)
- الإجمالي (بالريال)

## 🔄 التوافق مع النظام الحالي

- **أنواع الاشتراك الموجودة**: ستعمل بشكل طبيعي (admin_commission = null)
- **التقارير القديمة**: ستظهر "غير محدد" أو "0%" للنسبة
- **API**: متوافق مع الاستخدام الحالي

## 📝 ملاحظات مهمة

1. **النسبة اختيارية**: يمكن ترك الحقل فارغ
2. **النطاق المسموح**: 0% إلى 100%
3. **الحسابات تلقائية**: يتم حساب المبالغ تلقائياً
4. **التقارير محدثة**: جميع التقارير تعرض التفاصيل الجديدة
5. **التوافق**: لا يؤثر على الوظائف الموجودة
6. **⚠️ قاعدة حساب مهمة**: نسبة مكسب الإدارة تحسب من **سعر الاشتراك بدون التوصيل** وليس من السعر الكامل

## 🎯 الفوائد

- **شفافية مالية**: وضوح في حساب مستحقات كل طرف
- **مرونة في التسعير**: يمكن تحديد نسب مختلفة لكل نوع اشتراك
- **تقارير مفصلة**: تفاصيل كاملة عن الأسعار والأرباح
- **سهولة الإدارة**: واجهة بسيطة لإدارة النسب

---

**تم تطوير هذه الميزة بواسطة**: AI Assistant  
**تاريخ الإضافة**: سبتمبر 2025  
**الحالة**: ✅ جاهزة للاستخدام

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحليل مشكلة عد الوجبات</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2f6e73, #1f5a5f);
            color: white;
            border-radius: 15px;
        }
        
        .debug-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid #e9ecef;
        }
        
        .debug-title {
            color: #2f6e73;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .debug-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .test-button {
            background: linear-gradient(135deg, #2f6e73, #1f5a5f);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(47, 110, 115, 0.3);
        }
        
        .meal-info {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .meal-info h4 {
            color: #2f6e73;
            margin: 0 0 10px 0;
        }
        
        .meal-info p {
            margin: 5px 0;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 تحليل مشكلة عد الوجبات</h1>
            <p>تحليل دالة getWeekDaysFromStartDate مع 5 وجبات</p>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">
                <span>📊</span>
                <span>نتائج تحليل getWeekDaysFromStartDate</span>
            </div>
            
            <button class="test-button" onclick="testWith5Meals()">اختبار مع 5 وجبات</button>
            <button class="test-button" onclick="testWith6Meals()">اختبار مع 6 وجبات</button>
            <button class="test-button" onclick="testWith7Meals()">اختبار مع 7 وجبات</button>
            
            <div id="debugOutput" class="debug-output">انقر على أحد الأزرار لبدء التحليل...</div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">
                <span>🍽️</span>
                <span>تفاصيل الوجبات المُنشأة</span>
            </div>
            
            <div id="mealDetails"></div>
        </div>
    </div>

    <script>
        // محاكاة دالة getWeekDaysFromStartDate
        function getWeekDaysFromStartDate(startDate, selectedSubscriptionType, language = 'ar') {
            if (!startDate || !selectedSubscriptionType) return [];
            
            const start = new Date(startDate);
            const days = [];
            const requiredMeals = selectedSubscriptionType.meals_count || 4;
            
            // Generate labels and icons based on required meals
            const mealLabelsArray = language === 'ar' 
                ? ['الوجبة الأولى', 'الوجبة الثانية', 'الوجبة الثالثة', 'الوجبة الرابعة', 'الوجبة الخامسة', 'الوجبة السادسة', 'الوجبة السابعة', 'الوجبة الثامنة', 'الوجبة التاسعة', 'الوجبة العاشرة', 'الوجبة الحادية عشر', 'الوجبة الثانية عشر', 'الوجبة الثالثة عشر', 'الوجبة الرابعة عشر', 'الوجبة الخامسة عشر', 'الوجبة السادسة عشر']
                : ['Meal 1', 'Meal 2', 'Meal 3', 'Meal 4', 'Meal 5', 'Meal 6', 'Meal 7', 'Meal 8', 'Meal 9', 'Meal 10', 'Meal 11', 'Meal 12', 'Meal 13', 'Meal 14', 'Meal 15', 'Meal 16'];
            
            // Define meal icons for each meal
            const mealIconsArray = ['🍽️', '🥘', '🍲', '🍛', '🍜', '🍝', '🍱', '🥗', '🍳', '🥙', '🌮', '🌯', '🍕', '🍔', '🌭', '🥪'];
            
            const mealLabels = [];
            const mealIcons = [];
            const dayKeys = [];
            
            console.log(`\n=== تحليل إنشاء dayKeys لـ ${requiredMeals} وجبات ===`);
            
            for (let i = 0; i < requiredMeals; i++) {
                const weekIndex = Math.floor(i / 4); // 4 days per week
                const dayIndex = i % 4; // 0-3 for each week
                
                mealLabels.push(mealLabelsArray[i]);
                mealIcons.push(mealIconsArray[i] || '🍽️');
                
                // For monthly subscriptions, we need to repeat the same days
                const dayLabels = language === 'ar' 
                    ? ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء']
                    : ['Sunday', 'Monday', 'Tuesday', 'Wednesday'];
                
                // Always use English day names for backend compatibility
                const englishDayLabels = ['sunday', 'monday', 'tuesday', 'wednesday'];
                const baseDayKey = englishDayLabels[dayIndex];
                const uniqueDayKey = selectedSubscriptionType.type === 'monthly' 
                    ? `${baseDayKey}_week${weekIndex + 1}` 
                    : baseDayKey;
                dayKeys.push(uniqueDayKey);
                
                console.log(`الوجبة ${i + 1}: weekIndex=${weekIndex}, dayIndex=${dayIndex}, baseDayKey=${baseDayKey}, uniqueDayKey=${uniqueDayKey}`);
            }
            
            let currentDate = new Date(start);
            let mealIndex = 0;
            
            // Generate meal days based on subscription type
            while (mealIndex < requiredMeals) {
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek >= 0 && dayOfWeek <= 3) { // Sunday = 0, Wednesday = 3 (only 4 days per week)
                    days.push({
                        key: dayKeys[mealIndex],
                        label: mealLabels[mealIndex],
                        icon: mealIcons[mealIndex],
                        date: currentDate.toISOString().split('T')[0],
                        displayDate: currentDate.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            calendar: 'gregory'
                        }),
                        weekNumber: Math.floor(mealIndex / 4) + 1,
                        dayOfWeek: dayOfWeek
                    });
                    mealIndex++;
                }
                
                // Move to next day
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            console.log(`\n=== النتيجة النهائية ===`);
            console.log(`عدد الوجبات المطلوبة: ${requiredMeals}`);
            console.log(`عدد الوجبات المُنشأة: ${days.length}`);
            console.log(`dayKeys: [${dayKeys.join(', ')}]`);
            
            return days;
        }
        
        function testWith5Meals() {
            const startDate = '2024-01-07'; // Sunday
            const subscriptionType = {
                meals_count: 5,
                type: 'weekly'
            };
            
            const result = getWeekDaysFromStartDate(startDate, subscriptionType);
            
            document.getElementById('debugOutput').textContent = 
                `اختبار مع 5 وجبات:\n` +
                `عدد الوجبات المطلوبة: ${subscriptionType.meals_count}\n` +
                `عدد الوجبات المُنشأة: ${result.length}\n\n` +
                `تفاصيل الوجبات:\n${result.map((day, index) => 
                    `${index + 1}. ${day.label} - ${day.key} - ${day.displayDate}`
                ).join('\n')}\n\n` +
                `dayKeys: [${result.map(d => d.key).join(', ')}]`;
            
            displayMealDetails(result);
        }
        
        function testWith6Meals() {
            const startDate = '2024-01-07'; // Sunday
            const subscriptionType = {
                meals_count: 6,
                type: 'weekly'
            };
            
            const result = getWeekDaysFromStartDate(startDate, subscriptionType);
            
            document.getElementById('debugOutput').textContent = 
                `اختبار مع 6 وجبات:\n` +
                `عدد الوجبات المطلوبة: ${subscriptionType.meals_count}\n` +
                `عدد الوجبات المُنشأة: ${result.length}\n\n` +
                `تفاصيل الوجبات:\n${result.map((day, index) => 
                    `${index + 1}. ${day.label} - ${day.key} - ${day.displayDate}`
                ).join('\n')}\n\n` +
                `dayKeys: [${result.map(d => d.key).join(', ')}]`;
            
            displayMealDetails(result);
        }
        
        function testWith7Meals() {
            const startDate = '2024-01-07'; // Sunday
            const subscriptionType = {
                meals_count: 7,
                type: 'weekly'
            };
            
            const result = getWeekDaysFromStartDate(startDate, subscriptionType);
            
            document.getElementById('debugOutput').textContent = 
                `اختبار مع 7 وجبات:\n` +
                `عدد الوجبات المطلوبة: ${subscriptionType.meals_count}\n` +
                `عدد الوجبات المُنشأة: ${result.length}\n\n` +
                `تفاصيل الوجبات:\n${result.map((day, index) => 
                    `${index + 1}. ${day.label} - ${day.key} - ${day.displayDate}`
                ).join('\n')}\n\n` +
                `dayKeys: [${result.map(d => d.key).join(', ')}]`;
            
            displayMealDetails(result);
        }
        
        function displayMealDetails(days) {
            const container = document.getElementById('mealDetails');
            container.innerHTML = '';
            
            days.forEach((day, index) => {
                const mealInfo = document.createElement('div');
                mealInfo.className = 'meal-info';
                mealInfo.innerHTML = `
                    <h4>${day.label}</h4>
                    <p><strong>Key:</strong> ${day.key}</p>
                    <p><strong>Date:</strong> ${day.displayDate}</p>
                    <p><strong>Week Number:</strong> ${day.weekNumber}</p>
                    <p><strong>Day of Week:</strong> ${day.dayOfWeek}</p>
                    <p><strong>Icon:</strong> ${day.icon}</p>
                `;
                container.appendChild(mealInfo);
            });
        }
    </script>
</body>
</html>
